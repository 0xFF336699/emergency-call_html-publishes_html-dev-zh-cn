# 最终方案：物理分离，只上传 HTML (手动创建目录)
name: Deploy ONLY HTML to Qiniu

on:
  push:
    branches:
      - main # 或者你的触发分支

jobs:
  deploy-html-only:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Upload ONLY HTML files to Qiniu
        env:
          # 请确保这些 Secrets 已经在你的仓库中设置好
          QINIU_BUCKET_NAME: ${{ secrets.QINIU_BUCKET_NAME }}
          QINIU_ACCESS_KEY: ${{ secrets.QINIU_ACCESS_KEY }}
          QINIU_SECRET_KEY: ${{ secrets.QINIU_SECRET_KEY }}
          QINIU_DOMAIN: ${{ secrets.QINIU_DOMAIN }} # 新增一个域名 Secret
        run: |
          # --- 1. 准备工作 ---
          echo "Downloading and setting up qshell v2.16.0..."
          wget https://github.com/qiniu/qshell/releases/download/v2.16.0/qshell-v2.16.0-linux-amd64.tar.gz -O qshell.tar.gz
          tar -xvf qshell.tar.gz
          chmod +x qshell
          
          echo "Configuring qshell account..."
          ./qshell account $QINIU_ACCESS_KEY $QINIU_SECRET_KEY deploy_user

          # --- 2. 核心步骤：创建只包含 HTML 的临时目录 ---
          echo "Creating a temporary directory with only HTML files..."
          # 目标目录
          TARGET_DIR="html_only"
          mkdir -p $TARGET_DIR
          
          # 查找所有 HTML 文件并复制
          find docs -type f -name "*.html" | while read -r filepath; do
            # 在目标目录中创建相应的父目录
            mkdir -p "$TARGET_DIR/$(dirname "$filepath")"
            # 复制文件
            cp "$filepath" "$TARGET_DIR/$filepath"
          done
          
          echo "--- Verifying contents of the temporary directory ---"
          # 打印出临时目录的结构，以供检查
          ls -R $TARGET_DIR

          # --- 3. 上传这个只包含 HTML 的临时目录 ---
          echo "Uploading the temporary directory..."
          cat > qupload-html.json << EOF
          {
              "src_dir": "$TARGET_DIR/docs",
              "bucket": "$QINIU_BUCKET_NAME",
              "overwrite": true,
              "rescan_local": true,
              "log_level": "info"
          }
          EOF
          
          ./qshell qupload -c 10 qupload-html.json

          # --- 4. 刷新 CDN 缓存 ---
          echo "Refreshing CDN cache for HTML files..."
          # 从原始目录查找 HTML，生成刷新列表
          find docs -type f -name "*.html" | sed 's/docs\///' > html-files.txt
          # 使用 QINIU_DOMAIN 这个 Secret 来构建 URL
          sed -e 's/index\.html$//' -e 's/\.html$//' html-files.txt | awk -v domain="https://emc-website-dev-zh-cn.qiniu.fanfanlo.com/" '{print domain$0}' > urls_to_refresh.txt
          
          echo "--- URLs to be refreshed ---"
          cat urls_to_refresh.txt
          
          # 执行刷新, 请在确认无误后取消注释
          # ./qshell cdnrefresh -i urls_to_refresh.txt

          echo "HTML-only deployment completed successfully."
