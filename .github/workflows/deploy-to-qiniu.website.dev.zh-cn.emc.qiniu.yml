# GitHub Actions 工作流程：部署静态网站到七牛云对象存储 Kodo
# 最终版本 - 全程使用 qshell，不再依赖外部 Action
#
# 使用前请确保：
# 1. 在 GitHub 仓库的 Settings -> Secrets and variables -> Actions 中设置了以下两个 Secret:
#    - QINIU_ACCESS_KEY: 你的七牛云 Access Key
#    - QINIU_SECRET_KEY: 你的七牛云 Secret Key
# 2. 修改下面标记为 "TODO" 的占位符。

name: Deploy Website to Qiniu Cloud (qshell)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 第 1 步：拉取你的 GitHub 仓库代码
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 第 2 步：构建你的网站
      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          # 移除了 cache: 'npm' 来解决 "lock file not found" 错误
          
      - name: Install Dependencies and Build Project
        run: |
          npm install
          npm run build 

      # 第 3 步：使用 qshell 上传文件并设置缓存策略
      - name: Upload to Kodo and Set Cache with qshell
        run: |
          # --- 准备工作 ---
          echo "Downloading and setting up qshell..."
          wget https://github.com/qiniu/qshell/releases/download/v2.10.0/qshell-v2.10.0-linux-amd64.tar.gz -O qshell.tar.gz
          tar -xvf qshell.tar.gz
          mv qshell-v2.10.0-linux-amd64 qshell
          chmod +x qshell
          
          echo "Configuring qshell account..."
          ./qshell account ${{ secrets.QINIU_ACCESS_KEY }} ${{ secrets.QINIU_SECRET_KEY }} deploy_user
          
          # --- 上传文件 ---
          echo "Uploading files from 'docs' directory..."
          # 创建 qshell 上传配置文件
          cat > qupload.json << EOF
          {
              "src_dir": "docs",
              "bucket": "your-bucket-name",
              "overwrite": true,
              "rescan_local": true
          }
          EOF
          
          # 使用 env 变量替换 bucket 名称
          sed -i "s/your-bucket-name/${QINIU_BUCKET_NAME}/g" qupload.json

          # 执行上传，10是并发线程数
          ./qshell qupload 10 qupload.json

          # --- 设置缓存 ---
          echo "Setting 'no-cache' for all HTML files..."
          BUCKET_NAME="${QINIU_BUCKET_NAME}"
          
          ./qshell listbucket $BUCKET_NAME | grep '\.html$' | awk '{print $1}' | while read key; do
            echo "Setting 'Cache-Control: no-cache' for file: $key"
            ./qshell chgm $BUCKET_NAME "$key" 'Cache-Control: no-cache'
          done

          echo "Deployment process completed successfully."
        env:
          # TODO: 在下面填入你的 Bucket 名称
          QINIU_BUCKET_NAME: emc-website-dev-zh-cn
